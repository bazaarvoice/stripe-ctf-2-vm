#!/bin/bash
#
# Unlock a level.
#
# Usage: ctf-unlock <level> <password>
# E.g.: ctf-unlock 1 not-the-real-password
#

set -o nounset
set -o errexit

DIR="$( cd "$( dirname "$0" )" && pwd)"

function usage () {
  cat <<EOF
This must run as root using sudo.

sudo ${0} <level> <password>
E.g.: sudo ${0} 1 not-the-real-password
EOF
  exit 1
}

# Check arguments.
if [[ "${#}" -ne "2" ]]; then
  usage
fi

# Must be run as root via sudo.
if [[ "${EUID}" -ne "0" ]]; then
  usage
fi

LEVEL="${1}"
PASSWORD="${2}"

LEVELS_DIR="/var/ctf/levels"

PASSWORD_FILE="${LEVELS_DIR}/${LEVEL}.pwd"
UNLOCK_FILE="${LEVELS_DIR}/${LEVEL}.unlocked"

# Is LEVEL valid?
if [ ! -f "${PASSWORD_FILE}" ];
  echo "Invalid level specified: ${LEVEL}"
  exit 1
fi

# Is PASSWORD valid?
#
# Get the actual password minus whitespace.
PASSWORD_FROM_FILE=`cat "${PASSWORD_FILE}" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//'`

if [ "${PASSWORD}" != "${PASSWORD_FROM_FILE}" ]; do
  echo "Invalid password provided."
  exit 1
fi

# Unlock the level.
touch ${UNLOCK_FILE}
echo "Level ${LEVEL} is unlocked."






